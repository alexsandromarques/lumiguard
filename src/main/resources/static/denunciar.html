<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="UTF-8">
	<title>Denunciar - LumiGuard</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		input[readonly] {
			background-color: #e9ecef;
		}

		.loading {
			color: #6c757d;
			font-style: italic;
		}
	</style>
</head>

<body class="bg-light">
	<!-- Menu de navegação -->
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
		<div class="container">
			<a class="navbar-brand" href="index.html">LumiGuard</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
				aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav me-auto mb-2 mb-lg-0">
					<li class="nav-item"><a class="nav-link active" href="denunciar.html">Denunciar</a></li>
					<li class="nav-item"><a class="nav-link" href="mapa.html">Mapa de Denúncias</a></li>
					<li class="nav-item"><a class="nav-link" href="risco.html">Consultar Risco</a></li>
					<li class="nav-item"><a class="nav-link" href="lista.html">Lista de Denúncias</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<!-- Formulário de Denúncia -->
	<div class="container">
		<div class="card shadow-sm">
			<div class="card-body">
				<h4 class="card-title mb-4">Registrar Denúncia</h4>

				<form onsubmit="enviarFormulario(event)">
					<!-- Sessão: Endereço -->
					<h5 class="mt-3">Localização</h5>
					<div class="row">
						<div class="col-md-3 mb-3">
							<label class="form-label">CEP</label>
							<input id="cep" class="form-control" required maxlength="8" pattern="\d{8}"
								title="Apenas números" oninput="this.value=this.value.replace(/\D/g,'')"
								onblur="buscarCep()" />
						</div>
					</div>

					<div class="row">
						<div class="col-md-12 mb-3">
							<label class="form-label">Rua</label>
							<input id="rua" class="form-control" readonly required />
						</div>

					</div>

					<div class="row">
						<div class="col-md-2 mb-3">
							<label class="form-label">Número</label>
							<input id="numero" class="form-control" required />
						</div>

						<div class="col-md-4 mb-3">
							<label class="form-label">Bairro</label>
							<input id="bairro" class="form-control" readonly required />
						</div>
						<div class="col-md-4 mb-3">
							<label class="form-label">Cidade</label>
							<input id="cidade" class="form-control" readonly required />
						</div>

						<div class="col-md-2 mb-3">
							<label class="form-label">Estado</label>
							<input id="estado" class="form-control" readonly required />
						</div>
					</div>

					<!-- Sessão: Dados da denúncia -->
					<h5 class="mt-4">Detalhes da Falha</h5>
					<div class="row">
						<div class="col-md-12 mb-3">
							<label class="form-label">Tipo de Falha</label>
							<select id="tipoFalha" class="form-select" required>
								<option value="">Selecione</option>
								<option value="APAGADO">Apagado</option>
								<option value="PISCANDO">Piscando</option>
								<option value="INTERMITENTE">Intermitente</option>
								<option value="OUTRO">Outro</option>
							</select>
						</div>
					</div>

					<div class="mb-3">
						<label class="form-label">Descrição</label>
						<textarea id="descricao" class="form-control" rows="3"></textarea>
					</div>

					<button type="submit" class="btn btn-primary">Enviar</button>
				</form>
			</div>
		</div>
	</div>

	<script>
		async function buscarCep() {
			const cep = document.getElementById('cep').value.replace(/\D/g, '');
			if (cep.length !== 8) return;

			// Mostrar "Buscando..." ao submeter o CEP
			document.getElementById('rua').value = 'Buscando...';
			document.getElementById('bairro').value = 'Buscando...';
			document.getElementById('cidade').value = 'Buscando...';
			document.getElementById('estado').value = 'Buscando...';

			try {
				const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
				const dados = await res.json();

				if (dados.erro) {
					alert("CEP não encontrado.");
					return;
				}

				document.getElementById('rua').value = dados.logradouro;
				document.getElementById('bairro').value = dados.bairro;
				document.getElementById('cidade').value = dados.localidade;
				document.getElementById('estado').value = dados.uf;
			} catch (e) {
				alert("Erro ao buscar o CEP. Verifique sua conexão.");
				document.getElementById('rua').value = '';
				document.getElementById('bairro').value = '';
				document.getElementById('cidade').value = '';
				document.getElementById('estado').value = '';
			}
		}

		async function enviarFormulario(event) {
			event.preventDefault();

			const localizacao = `${document.getElementById('rua').value}, ${document.getElementById('numero').value}, ${document.getElementById('bairro').value}, ${document.getElementById('cidade').value} - ${document.getElementById('estado').value}, ${document.getElementById('cep').value}`;

			const body = {
				localizacao,
				tipoFalha: document.getElementById('tipoFalha').value,
				descricao: document.getElementById('descricao').value
			};

			const res = await fetch('/api/denuncias/criar', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify(body)
			});

			if (res.ok) {
				alert("Denúncia registrada com sucesso!");
				window.location.reload();
			} else {
				alert("Erro ao enviar denúncia.");
			}
		}
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
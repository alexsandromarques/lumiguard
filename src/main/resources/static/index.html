<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="UTF-8" />
	<title>Denunciar - LumiGuard</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
	<style>
		body {
			background: linear-gradient(to right, #0d6efd, #5c9dfd);
			color: #fff;
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 30px 15px;
		}

		.card {
			border: none;
			border-radius: 16px;
		}

		.card-body {
			padding: 2rem;
		}

		.form-control,
		.form-select {
			border-radius: 8px;
		}

		.section-title {
			font-weight: 700;
			font-size: 2rem;
			text-align: center;
			margin-bottom: 10px;
			color: #fff;
		}

		.section-subtitle {
			font-size: 1rem;
			text-align: center;
			margin-bottom: 30px;
			color: #f1f1f1;
			max-width: 600px;
			margin-left: auto;
			margin-right: auto;
		}

		.container-max {
			max-width: 900px;
			width: 100%;
		}

		.btn-primary {
			border-radius: 8px;
			padding: 0.75rem;
			font-weight: bold;
		}

		.logo {
			font-size: 2rem;
			font-weight: bold;
			text-align: center;
			color: #fff;
			margin-bottom: 10px;
		}
		
		input[readonly] {
		  background-color: #e9ecef !important;
		  color: #6c757d;
		}
	</style>
</head>

<body>
	<div class="container-max">
		<div class="logo">LumiGuard</div>
		<h1 class="section-title">Ajude a manter nossa cidade mais iluminada e segura</h1>
		<p class="section-subtitle">
			Utilize este formulário para relatar problemas na iluminação pública da sua rua. Sua denúncia será enviada à
			equipe responsável para que medidas sejam tomadas o mais rápido possível.
		</p>

		<div class="card shadow-lg">
			<div class="card-body bg-white text-dark">
				<h4 class="mb-4 text-center">Formulário de Denúncia</h4>

				<form onsubmit="enviarFormulario(event)">
					<!-- Localização -->
					<h5 class="mt-3">Localização</h5>
					<div class="row">
						<div class="col-md-4 mb-3">
							<label class="form-label">CEP</label>
							<input id="cep" class="form-control" required maxlength="8" pattern="\d{8}"
								title="Apenas números" oninput="this.value=this.value.replace(/\D/g,'')"
								onblur="buscarCep()" />
						</div>

					</div>

					<div class="row">

						<div class="col-md-9 mb-3">
							<label class="form-label">Rua</label>
							<input id="rua" class="form-control" readonly required />
						</div>

						<div class="col-md-3 mb-3">
							<label class="form-label">Número</label>
							<input id="numero" class="form-control" required />
						</div>

					</div>

					<div class="row">

						<div class="col-md-5 mb-3">
							<label class="form-label">Bairro</label>
							<input id="bairro" class="form-control" readonly required />
						</div>
						<div class="col-md-4 mb-3">
							<label class="form-label">Cidade</label>
							<input id="cidade" class="form-control" readonly required />
						</div>
						<div class="col-md-3 mb-3">
							<label class="form-label">Estado</label>
							<input id="estado" class="form-control" readonly required />
						</div>
					</div>

					<!-- Detalhes -->
					<h5 class="mt-4">Detalhes da Falha</h5>
					<div class="mb-3">
						<label class="form-label">Tipo de Falha</label>
						<select id="tipoFalha" class="form-select" required>
							<option value="">Selecione</option>
							<option value="APAGADO">Apagado</option>
							<option value="PISCANDO">Piscando</option>
							<option value="INTERMITENTE">Intermitente</option>
							<option value="OUTRO">Outro</option>
						</select>
					</div>

					<div class="mb-4">
						<label class="form-label">Descrição (opcional)</label>
						<textarea id="descricao" class="form-control" rows="3"></textarea>
					</div>

					<div class="d-grid">
						<button type="submit" class="btn btn-primary">Enviar Denúncia</button>
					</div>
				</form>
			</div>
		</div>

		<div class="text-center mt-3">
			<a href="login.html" style="font-size: 0.9rem; color: #e0e0e0; text-decoration: none;">
				Acesso restrito
			</a>
		</div>

	</div>



	<!-- Scripts -->
	<script>
		async function buscarCep() {
			const cep = document.getElementById('cep').value.replace(/\D/g, '');
			if (cep.length !== 8) return;

			document.getElementById('rua').value = 'Buscando...';
			document.getElementById('bairro').value = 'Buscando...';
			document.getElementById('cidade').value = 'Buscando...';
			document.getElementById('estado').value = 'Buscando...';

			try {
				const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
				const dados = await res.json();

				if (dados.erro) {
					alert("CEP não encontrado.");
					return;
				}

				document.getElementById('rua').value = dados.logradouro;
				document.getElementById('bairro').value = dados.bairro;
				document.getElementById('cidade').value = dados.localidade;
				document.getElementById('estado').value = dados.uf;
			} catch (e) {
				alert("Erro ao buscar o CEP. Verifique sua conexão.");
				document.getElementById('rua').value = '';
				document.getElementById('bairro').value = '';
				document.getElementById('cidade').value = '';
				document.getElementById('estado').value = '';
			}
		}

		async function enviarFormulario(event) {
			event.preventDefault();

			const localizacao = `${document.getElementById('rua').value}, ${document.getElementById('numero').value}, ${document.getElementById('bairro').value}, ${document.getElementById('cidade').value} - ${document.getElementById('estado').value}, ${document.getElementById('cep').value}`;

			const body = {
				localizacao,
				tipoFalha: document.getElementById('tipoFalha').value,
				descricao: document.getElementById('descricao').value
			};

			const res = await fetch('/lumiguard/api/denuncias/criar', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify(body)
			});

			if (res.ok) {
				alert("Denúncia registrada com sucesso!");
				window.location.reload();
			} else {
				alert("Erro ao enviar denúncia.");
			}
		}
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>